<html>
  <head>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>

    <style>
    body div{
      border: solid 1px black;
      margin-bottom: 5px;
      padding: 0.5rem
    }
    </style>
  </head>
  <body>
    <h1>My Weekend Project</h1>
    <div class='question1'>
      <h2>Finding Products in Price Range $1-$15</h2>
      <ul id='question1'></ul>
    </div>
    <div class='question2'>
      <h2>Grouping Companies by Letter</h2>
      <ul id='question2'></ul>
    </div>
    <div class='question3'>
      <h2>Grouping Companies by State</h2>
      <ul id='question3'></ul>
    </div>
    <div class='question4'>
      <h2>Offers made by Companies for Product </h2>
      <ul id='question4'></ul>
    </div>
    <div class='question5'>
      <h2>Companies with n or more offerings</h2>
      <ul id='question5'></ul>
    </div>
    <div class='question6'>
      <h2>Average Price for Each Offering</h2>
      <ul id='question6'></ul>
    </div>



    <script>

      const loadData = async() => {
        const urls = [
          'https://acme-users-api-rev.herokuapp.com/api/companies',
          'https://acme-users-api-rev.herokuapp.com/api/products',
          'https://acme-users-api-rev.herokuapp.com/api/offerings'
        ];
        const responses = await Promise.all(urls.map( url=> axios.get(url)));

        const [companies, products, offerings ] = await Promise.all(responses.map( response => response.data));




        //return products within a price range
        const findProductsInPriceRange = (products, obj)=>{
          const max = obj.max;
          return products.filter(product => product.suggestedPrice <= max);
        }
        const productsInPriceRange = findProductsInPriceRange (products, {min: 1, max: 15});
        // console.log(productsInPriceRange);
        const html1 = productsInPriceRange.map(product =>{
          return `<li>Product: ${product.name}  at a suggested price of: $${product.suggestedPrice}</li>`
        }).join('');
        document.querySelector('#question1').innerHTML = html1;


        //returns object where key is first etter of compnay name
        //value for each key is the array of those companies
        const groupCompaniesByLetter = (companies) => {
          let obj = {};
          let sorted = companies.map(company => {
            if(obj[company.name[0]]){
              obj[company.name[0]].push(company);
            }
            else{
              obj[company.name[0]]=[company];
            }
          });
          return obj;
        }
        const groupedCompaniesByLetter = groupCompaniesByLetter(companies);
        // console.log(groupedCompaniesByLetter);
        const keys = Object.keys(groupedCompaniesByLetter)
        let arr = [];
        arr.push(groupedCompaniesByLetter)
        const html2 = arr.map(object => {
          return keys.map(key =>{
            const value = object[key]
            const companies = value.map(company =>{
              return `<li>${company.name}</li>`
            }).join('');
            return `<li>${key}:<ul>${companies}</ul></li>`
          }).join('');
        }).join('');
        document.querySelector('#question2').innerHTML = html2;


        //returns object where key is a state
        //value for each key is the array of those companies in that state
        const groupCompaniesByState = (companies) => {
          let obj = {};
          const sort = companies.map(company =>{
            if(!obj[company.state]){
              obj[company.state] = [company];
            }
            else{
              obj[company.state].push(company)
            }
          })
          return obj;
        }
        const groupedCompaniesByState = groupCompaniesByState(companies);
        // console.log(groupedCompaniesByState);
        const stateKeys = Object.keys(groupedCompaniesByState);
        let stateArr =[];
        stateArr.push(groupedCompaniesByState);
        const html3 = stateArr.map(object => {
          return stateKeys.map(key => {
            const companies = object[key].map(company => {
              return `<li>${company.name}</li>`
            }).join('');
            return `<li>${key}: <ul>${companies}</ul></li>`
          }).join('');
        }).join('');
        document.querySelector('#question3').innerHTML = html3


        //returns an array of the offerings with each offering having a company and product
        const processOfferings = ({companies, products, offerings}) => {
          return offerings.map(offer => {
            const company = companies.find( company => company.id === offer.companyId);
            const product = products.find( product => product.id === offer.productId );
            return {... offer, company, product};
          });
        };
        const processedOfferings = processOfferings({companies, products, offerings});
        // console.log(processedOfferings);
        const html4 = processedOfferings.map(offer =>{
          return `<li>${offer.company.name} is offering $${offer.price} for product: ${offer.product.name}</li>`
        }).join('');

        document.querySelector('#question4').innerHTML = html4;


      //returns the companies that have n or more offerings
      const companiesByNumberOfOfferings = (companies, offerings, number) =>{
        const companyOffers = companies.map(company =>{
          const offers = offerings.filter(offer => offer.companyId === company.id)
          return {...company, offers};
        });
        return companyOffers.filter(company => company.offers.length >= number)
      }
      const threeOrMoreOfferings = companiesByNumberOfOfferings(companies, offerings, 3);
      console.log(threeOrMoreOfferings);

      }
      loadData();

    </script>
  </body>
</html>
